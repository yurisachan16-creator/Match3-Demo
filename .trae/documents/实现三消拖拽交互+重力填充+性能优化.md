# 现状与实现边界

- 现在工程里 Match3SDK 只负责逻辑（交换/匹配检测/求解序列），渲染层是我们新增的 `GameBoardView`（SpriteRenderer 画彩色格子）。
- 你提出的需求包含：拖拽交互、匹配消除动画、重力下落补位、新元素入场、对象池、每帧限制、脏更新、FPS 预警、非法操作保护、音效/粒子/连锁。
- 工程已有可复用的 QFramework PoolKit / AudioKit，但没有现成 FPS HUD/粒子工具。

# 总体设计（把需求拆成 4 层）

## 1) 输入层：BoardInput（鼠标+触摸）
- 新增 `BoardInputController`（MonoBehaviour）挂在 `GameController` 同物体。
- 统一鼠标/触摸：
  - 鼠标：`Input.GetMouseButton*`
  - 触摸：`Input.touchCount` + `TouchPhase`
- 关键状态机：`Idle -> Dragging -> Swapping -> Resolving/Filling -> Idle`
- 保护机制：
  - Busy 时拒绝输入
  - Drag 冷却（cooldown）
  - 非法拖拽（拖到棋盘外、起点无物品、目标不可交换）直接回弹

## 2) 视图层：BoardView（可视化+动画+脏更新）
- 现有 `GameBoardView` 需要升级为“格子背景 + 物品对象”的结构：
  - 每个格子有 `SlotView`，内部持有 `ItemView`（SpriteRenderer）。
  - `ItemView` 才是会移动/缩放/淡出的对象。
- 提供 API（供输入/填充策略调用）：
  - `TryWorldToGrid(worldPos, out GridPosition)`
  - `Highlight(GridPosition, on/off)`
  - `ShowDragGhost(ItemView)`：半透明跟随（复用池）
  - `SwapAnimAsync(posA,posB,duration)`：平滑交换动画
  - `ClearAnimAsync(list<pos>)`：消除动画（缩放/淡出）
  - `FallAnimAsync(moves)`：下落动画
  - `SpawnAnimAsync(spawns)`：新物品入场动画（从上方落入/弹出）
- 脏矩形/脏更新：
  - 不做“整屏重绘”，只在 Slot 变化或动画过程中更新对应 ItemView。
  - 使用 `GameSlot.OnItemChanged` 仅触发单格刷新（已有基础）。

## 3) 逻辑层：Match3SDK 的对接方式
- 匹配检测：继续用 SDK 的 `HorizontalLineDetector/VerticalLineDetector`（已满足横竖匹配）。
- 交换触发：拖拽超过阈值后只交换相邻格（由输入层判定方向）。
- 消除/填充：用新的 `GravityFillStrategy` 替代当前 `SimpleFillStrategy`：
  - `GetFillJobs`：初始补满（带入场动画）
  - `GetSolveJobs`：
    1) 清空被消除格（触发消除动画）
    2) 列压缩下落（逻辑 ItemId 下移 + 视图下落动画）
    3) 顶部生成新元素（逻辑赋值 + 入场动画）
    4) 连锁：再次扫描匹配，若有则重复 1~3（设置最大连锁次数，避免死循环）
- 关键实现点：
  - Job 内部按列计算 move 列表（from->to），并把“受影响坐标”收集为脏集合。
  - 每帧处理元素数量限制：Job 处理 N 个 move/spawn/clear 后 `await UniTask.Yield()`。

## 4) 性能与资源（Pool + FPS）

### 对象池
复用 QFramework PoolKit：
- 物品对象/拖拽 ghost/粒子对象：用 `SimpleObjectPool<T>` 做 GameObject/组件池（更适合 MonoBehaviour/Prefab）。参考：
  - [SimpleObjectPool.cs](file:///d:/unity/Works/Match3-Demo/Assets/QFramework/Toolkits/_CoreKit/PoolKit/Scripts/SimpleObjectPool.cs)
- 临时 List/Dictionary：用 `ListPool/DictionaryPool` 降 GC：
  - [ListPool.cs](file:///d:/unity/Works/Match3-Demo/Assets/QFramework/Toolkits/_CoreKit/PoolKit/Scripts/ListPool.cs)
  - [DictionaryPool.cs](file:///d:/unity/Works/Match3-Demo/Assets/QFramework/Toolkits/_CoreKit/PoolKit/Scripts/DictionaryPool.cs)

### FPS 监控与预警
- 新增 `FpsMonitor`（MonoBehaviour）：
  - 每 0.5~1s 统计平均 FPS
  - 若连续 X 秒低于阈值（如 45fps）则 `Debug.LogWarning` / 可选 OnGUI 显示
- 或者扩展 ConsoleKit 做一个 FPS Module（后续可选）。ConsoleKit 框架：
  - [ConsoleKit.cs](file:///d:/unity/Works/Match3-Demo/Assets/QFramework/Toolkits/_CoreKit/ConsoleKit/Scripts/ConsoleKit.cs)

# 视觉/音效落地方式

## 拖拽高亮 + 半透明跟随
- 起点格：ItemView 加高亮（提高亮度/加描边或缩放 1.1）。
- Ghost：从池里取一个 SpriteRenderer，alpha=0.5 跟随指针。

## 消除粒子 + 音效
- 粒子：支持可选 Prefab（未配置时用最小粒子程序化创建）。粒子也走池。
- 音效：复用 AudioKit（可选配置音效名，空则不播，避免找不到资源）。入口参考：
  - [AudioKit.cs](file:///d:/unity/Works/Match3-Demo/Assets/QFramework/Toolkits/AudioKit/Scripts/API/AudioKit.cs)

# 具体交付物（文件级）

1. `Assets/Scripts/Match3/BoardInputController.cs`：拖拽输入、阈值判定、冷却与状态保护。
2. 升级 `Assets/Scripts/Match3/GameBoardView.cs`：SlotView/ItemView、WorldToGrid、动画 API、池化接口。
3. 新增 `Assets/Scripts/Match3/GravityFillStrategy.cs` + Jobs（Clear/Collapse/Spawn/ChainResolve），替换当前填充策略。
4. 调整 `Assets/Scripts/Match3/GameController.cs`：注入 BoardView、Input、策略配置、性能参数。
5. `Assets/Scripts/Match3/FpsMonitor.cs`：帧率显示与预警。
6. （可选）`Assets/Editor/*`：继续提供调试按钮（重建/打印/测试交换等）。

# 验收标准（你运行时应看到的结果）

- 拖拽任意格：出现半透明跟随、起点高亮。
- 拖拽超过阈值：只与相邻格交换，交换有平滑动画。
- 形成 3 连：播放消除动画 + 粒子（若配置）+ 音效（若配置）。
- 消除后：上方自然下落补位，新元素从上方落入，有入场动画。
- 连锁：二次/多次匹配会继续自动消除（有上限）。
- 性能：Tile/Item/Ghost/Particle 都通过对象池复用；Job 分帧处理；FPS 低于阈值会预警。

我将默认以 SpriteRenderer（2D）方案实现（最贴合当前 Demo）；接下来你确认后我就开始按上述文件拆分直接落地编码。